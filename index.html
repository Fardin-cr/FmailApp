<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Change Automation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- GLOBAL CONFIG (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;

        // --- FIREBASE INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                return new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("User is signed in with UID:", userId);
                        } else {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Anonymous sign-in failed:", error);
                                // Fallback user ID if all auth fails
                                userId = `local_${crypto.randomUUID()}`;
                            }
                        }
                        resolve();
                    });
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // Fallback user ID if Firebase fails to initialize
                userId = `local_${crypto.randomUUID()}`;
            }
        }

        // --- DATA PERSISTENCE ---
        async function saveUserPreferences(prefs) {
            if (!db || !userId) return;
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/passwordChangerPrefs/config`);
                await setDoc(userDocRef, prefs);
                console.log("Preferences saved:", prefs);
            } catch (error) {
                console.error("Error saving preferences:", error);
            }
        }

        async function loadUserPreferences() {
            if (!db || !userId) return null;
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/passwordChangerPrefs/config`);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    console.log("Preferences loaded:", docSnap.data());
                    return docSnap.data();
                }
                return null;
            } catch (error) {
                console.error("Error loading preferences:", error);
                return null;
            }
        }


        // --- APPLICATION LOGIC ---
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFirebase();

            const randomModeBtn = document.getElementById('randomModeBtn');
            const customModeBtn = document.getElementById('customModeBtn');
            const randomPassConfig = document.getElementById('randomPassConfig');
            const customPassConfig = document.getElementById('customPassConfig');
            const passwordInput = document.getElementById('passwordInput');
            const randLengthInput = document.getElementById('randLengthInput');
            const processBtn = document.getElementById('processBtn');
            const mailListInput = document.getElementById('mailListInput');
            const reportContainer = document.getElementById('reportContainer');
            const loader = document.getElementById('loader');
            const API_KEY = "61352fa0-f3e9-4ee7-90c8-bf8ae223add1";
            
            // --- FINAL URL POINTING TO YOUR LIVE NETLIFY PROXY ---
            const API_URL = "https://fmailapp24.netlify.app/.netlify/functions/proxy"; 

            let state = {
                mode: 'random', // 'random' or 'custom'
                randLength: 12,
                customPassword: ''
            };

            // --- UI FUNCTIONS ---
            function updateUIMode() {
                if (state.mode === 'random') {
                    randomModeBtn.classList.replace('bg-gray-700', 'bg-blue-600');
                    customModeBtn.classList.replace('bg-blue-600', 'bg-gray-700');
                    randomPassConfig.classList.remove('hidden');
                    customPassConfig.classList.add('hidden');
                } else {
                    customModeBtn.classList.replace('bg-gray-700', 'bg-blue-600');
                    randomModeBtn.classList.replace('bg-blue-600', 'bg-gray-700');
                    customPassConfig.classList.remove('hidden');
                    randomPassConfig.classList.add('hidden');
                }
            }
            
            async function loadAndApplyPreferences() {
                const prefs = await loadUserPreferences();
                if (prefs) {
                    state.mode = prefs.mode || 'random';
                    state.randLength = prefs.randLength || 12;
                    state.customPassword = prefs.customPassword || '';
                    
                    randLengthInput.value = state.randLength;
                    passwordInput.value = state.customPassword;
                }
                updateUIMode();
            }

            // --- EVENT LISTENERS ---
            randomModeBtn.addEventListener('click', () => {
                state.mode = 'random';
                updateUIMode();
                saveUserPreferences(state);
            });

            customModeBtn.addEventListener('click', () => {
                state.mode = 'custom';
                updateUIMode();
                saveUserPreferences(state);
            });
            
            randLengthInput.addEventListener('input', (e) => {
                const len = parseInt(e.target.value, 10);
                state.randLength = isNaN(len) || len < 8 ? 8 : (len > 64 ? 64 : len);
                saveUserPreferences(state);
            });

            passwordInput.addEventListener('input', (e) => {
                state.customPassword = e.target.value;
                saveUserPreferences(state);
            });

            processBtn.addEventListener('click', () => {
                const mailList = mailListInput.value.trim();
                if (!mailList) {
                    alert('Please enter a list of mails.');
                    return;
                }
                processMails(mailList);
            });
            
            await loadAndApplyPreferences();

            // --- CORE PROCESSING LOGIC ---
            function parseMailLines(text) {
                const pairs = [];
                const badLines = [];
                const lines = text.split(/\r?\n/);
                for (const raw of lines) {
                    const line = raw.trim();
                    if (!line) continue;
                    if (!line.includes(':')) {
                        badLines.push(line);
                        continue;
                    }
                    const [email, oldPass] = line.split(':', 2).map(s => s.trim());
                    if (!email || !oldPass) {
                        badLines.push(line);
                        continue;
                    }
                    pairs.push({ email, oldPass });
                }
                return { pairs, badLines };
            }

            function generatePassword(length) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

            async function changePassAPI(email, oldPass, newPass) {
                const payload = {
                    username: email,
                    cpassword: oldPass,
                    npassword: newPass,
                    api_key: API_KEY
                };
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorText}`);
                }
                
                return response.json();
            }

            async function changeWithRetries(email, oldPass, newPass) {
                let lastError = 'Unknown error';
                for (let attempt = 0; attempt < 3; attempt++) {
                    try {
                        const res = await changePassAPI(email, oldPass, newPass);
                        if (!res.error && res.message === "Password was updated") {
                            return { ok: true, email, oldPass, newPass, token: res.token };
                        }
                        lastError = res.message || res.detail || JSON.stringify(res);
                    } catch (e) {
                        lastError = `Network Error: Could not connect to the proxy. Ensure it is deployed and the URL is correct.`;
                        console.error(`Attempt ${attempt + 1} failed for ${email}:`, e);
                    }
                    if (attempt < 2) {
                        await new Promise(resolve => setTimeout(resolve, 800 * (attempt + 1)));
                    }
                }
                return { ok: false, email, oldPass, newPass, error: lastError };
            }

            async function processMails(mailList) {
                processBtn.disabled = true;
                loader.classList.remove('hidden');
                reportContainer.innerHTML = '';

                const { pairs, badLines } = parseMailLines(mailList);
                if (!pairs.length && badLines.length) {
                    renderReport([], [], badLines);
                    processBtn.disabled = false;
                    loader.classList.add('hidden');
                    return;
                }

                const newPassword = state.mode === 'custom' ? passwordInput.value : null;
                if (state.mode === 'custom' && (!newPassword || newPassword.length < 8)) {
                    alert('Custom password must be at least 8 characters long.');
                    processBtn.disabled = false;
                    loader.classList.add('hidden');
                    return;
                }

                const tasks = pairs.map(p => {
                    const passToSet = state.mode === 'random' ? generatePassword(state.randLength) : newPassword;
                    return changeWithRetries(p.email, p.oldPass, passToSet);
                });

                const results = await Promise.all(tasks);

                const successful = results.filter(r => r.ok);
                const failed = results.filter(r => !r.ok);
                
                renderReport(successful, failed, badLines);

                processBtn.disabled = false;
                loader.classList.add('hidden');
            }

            function renderReport(successful, failed, badLines) {
                let html = '';
                
                if (successful.length > 0) {
                    html += `
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold text-green-400 mb-3">✅ Successful (${successful.length})</h3>
                            <div class="bg-gray-800 rounded-lg p-4 font-mono text-sm text-gray-300 space-y-2 overflow-x-auto">`;
                    successful.forEach(r => {
                        html += `<div>${escapeHtml(r.email)}:${escapeHtml(r.newPass)}</div>`;
                    });
                    html += `</div></div>`;
                }

                if (failed.length > 0) {
                     html += `
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold text-red-400 mb-3">❌ Failed Attempts (${failed.length})</h3>
                            <div class="bg-gray-800 rounded-lg p-4 font-mono text-sm text-gray-300 space-y-2 overflow-x-auto">`;
                    failed.forEach(r => {
                        html += `<div>${escapeHtml(r.email)} &mdash; <span class="text-red-300">${escapeHtml(r.error)}</span></div>`;
                    });
                    html += `</div></div>`;
                }

                if (badLines.length > 0) {
                    html += `
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold text-yellow-400 mb-3">⚠️ Invalid Format (${badLines.length})</h3>
                            <div class="bg-gray-800 rounded-lg p-4 font-mono text-sm text-gray-300 space-y-2 overflow-x-auto">`;
                    badLines.forEach(line => {
                        html += `<div>${escapeHtml(line)}</div>`;
                    });
                    html += `</div></div>`;
                }

                reportContainer.innerHTML = html;
            }
            
            function escapeHtml(unsafe) {
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            }
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
        }
        .btn-mode.bg-blue-600 {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; } /* gray-800 */
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; } /* gray-600 */
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* gray-500 */
    </style>
</head>
<body class="text-gray-200">

    <div class="min-h-screen flex items-center justify-center p-4">
        <main class="w-full max-w-4xl bg-gray-900 border border-gray-700/50 rounded-2xl shadow-2xl shadow-black/30 p-8">
            
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white tracking-tight">Password Change Automation</h1>
                <p class="text-gray-400 mt-2">Process multiple email accounts with ease.</p>
            </header>

            <!-- Step 1: Mode Selection -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-300 mb-3">Step 1: Choose Password Mode</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button id="randomModeBtn" class="btn-mode w-full bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all duration-300">
                        🔑 Random Password
                    </button>
                    <button id="customModeBtn" class="btn-mode w-full bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all duration-300">
                        ✍️ Custom Password
                    </button>
                </div>
            </div>

            <!-- Step 2: Configuration -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-300 mb-3">Step 2: Configure Password</h2>
                <div id="randomPassConfig" class="bg-gray-800/50 p-4 rounded-lg">
                    <label for="randLengthInput" class="block text-sm font-medium text-gray-400 mb-2">Password Length (8-64)</label>
                    <input type="number" id="randLengthInput" value="12" min="8" max="64" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div id="customPassConfig" class="bg-gray-800/50 p-4 rounded-lg hidden">
                     <label for="passwordInput" class="block text-sm font-medium text-gray-400 mb-2">Enter Your Custom Password</label>
                    <input type="password" id="passwordInput" placeholder="Must be at least 8 characters" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
            </div>
            
            <!-- Step 3: Mail Input -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-300 mb-3">Step 3: Enter Mail List</h2>
                <textarea id="mailListInput" rows="10" placeholder="elise1961@firstmail.com:oldpass123&#10;another@firstmail.com:anotherpass456" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg p-4 text-gray-300 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
            </div>
            
            <!-- Step 4: Process -->
            <div class="text-center">
                <button id="processBtn" class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-500 disabled:cursor-not-allowed text-white font-bold py-3 px-8 rounded-lg text-lg transition-all duration-300 flex items-center justify-center w-full max-w-xs mx-auto">
                    <span class="mr-2">Process Mails</span>
                    <svg id="loader" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>

            <!-- Step 5: Report -->
            <div id="reportContainer" class="mt-10">
                <!-- Results will be rendered here -->
            </div>

        </main>
    </div>
</body>
</html>

